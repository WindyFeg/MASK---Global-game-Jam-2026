<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Balancer: Survival</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --panel-bg: #16213e;
            --card-bg: #e94560;
            --text-main: #ecf0f1;
            --happy-color: #f1c40f;
            --money-color: #2ecc71;
            --danger-color: #e74c3c;
            --accent-color: #0f3460;
            --penalty-bg: #4a0e0e; /* M√†u n·ªÅn cho l√° b√†i b·ªã ph·∫°t */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        /* --- Header & Stats --- */
        .top-bar {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid #333;
        }

        .stat-group { text-align: center; flex: 1; }
        .stat-label { font-size: 0.9rem; color: #aaa; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;}
        .stat-display { font-size: 1.4rem; font-weight: bold; display: flex; justify-content: center; gap: 15px; }
        .icon { margin-right: 5px; }

        /* --- NPC Section --- */
        .npc-container {
            background: linear-gradient(145deg, #1f4068, #162447);
            width: 100%;
            max-width: 600px;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.4);
            border: 2px solid #0f3460;
            position: relative;
            overflow: hidden;
        }
        
        .npc-avatar { font-size: 3rem; margin-bottom: 5px; display: block; animation: bounce 2s infinite; }
        .npc-name { font-size: 1.5rem; font-weight: bold; color: #4db8ff; }
        .npc-status { font-size: 0.85rem; color: #ff9f43; margin-bottom: 10px; font-style: italic; background: rgba(0,0,0,0.3); padding: 2px 10px; border-radius: 10px; display: inline-block;}
        .dialog-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            font-style: italic;
            color: #ddd;
            margin: 10px 0;
            border-left: 4px solid var(--happy-color);
        }
        .request-tag {
            background: var(--danger-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* --- Cards --- */
        .cards-wrapper {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 800px;
        }

        .card {
            background: white;
            color: #333;
            width: 140px;
            height: 220px;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            border: 4px solid #bdc3c7;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .card:active { transform: scale(0.95); }

        .card-header { font-weight: 800; font-size: 1rem; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #eee; margin-bottom: 8px;}
        
        .card-body { font-size: 0.85rem; }
        .effect-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .badge { font-weight: bold; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
        .badge-player { background: #dff9fb; color: #2980b9; }
        .badge-npc { background: #ffeaa7; color: #d35400; }

        /* Penalty State */
        .card.penalty {
            background: var(--penalty-bg);
            color: #ecf0f1;
            border-color: #c0392b;
            animation: pulse-red 2s infinite;
        }
        .card.penalty .badge-player { background: #c0392b; color: white; }
        .card.penalty .badge-npc { background: #c0392b; color: white; }
        .penalty-warning {
            font-size: 0.7rem; color: #ff6b6b; text-align: center; 
            font-weight: bold; margin-top: 5px; text-transform: uppercase;
        }

        /* --- Animations --- */
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); } 100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); } }

        /* --- Overlays --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            color: white;
        }
        .overlay h1 { font-size: 3rem; margin: 0; }
        .overlay p { font-size: 1.2rem; max-width: 600px; line-height: 1.6; }
        .btn {
            margin-top: 20px; padding: 15px 40px; font-size: 1.2rem; font-weight: bold;
            border: none; border-radius: 50px; cursor: pointer; transition: 0.2s;
        }
        .btn-restart { background: #e74c3c; color: white; }
        .btn-restart:hover { background: #c0392b; }
        .btn-win { background: #f1c40f; color: #2c3e50; }

        /* --- Toast Notification --- */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="stat-group" style="border-right: 1px solid #444;">
            <div class="stat-label">B·∫†N (PLAYER)</div>
            <div class="stat-display">
                <span id="pMoneyVal" style="color:var(--money-color)">üí∞ 3</span>
                <span id="pHappyVal" style="color:var(--happy-color)">üòÇ 3</span>
            </div>
        </div>
        <div class="stat-group">
            <div class="stat-label">ƒê·ªêI T∆Ø·ª¢NG (NPC)</div>
            <div class="stat-display">
                <span id="nMoneyVal" style="color:var(--money-color)">üí∞ 3</span>
                <span id="nHappyVal" style="color:var(--happy-color)">üòÇ 3</span>
            </div>
        </div>
    </div>

    <div class="npc-container">
        <div class="npc-avatar" id="npcIcon">üëµ</div>
        <div class="npc-name" id="npcName">M·∫π</div>
        <div class="npc-status" id="npcContext">ƒêang b√¨nh th∆∞·ªùng</div>
        <div class="dialog-box" id="npcDialog">"Con trai, m·∫π c·∫ßn ti·ªÅn s·ª≠a l·∫°i c√°i m√°i nh√†..."</div>
        <div>M·ª•c ti√™u: <span class="request-tag" id="npcRequest">C·∫¶N +TI·ªÄN</span></div>
    </div>

    <div class="cards-wrapper" id="cardsArea">
        </div>

    <div id="gameOverOverlay" class="overlay">
        <h1 style="color: #e74c3c">TH·∫§T B·∫†I</h1>
        <p id="failReason">B·∫°n ƒë√£ h·∫øt ti·ªÅn.</p>
        <button class="btn btn-restart" onclick="initGame()">Ch∆°i L·∫°i T·ª´ ƒê·∫ßu</button>
    </div>

    <div id="winOverlay" class="overlay">
        <h1 style="color: #f1c40f">CHI·∫æN TH·∫ÆNG!</h1>
        <p>Tuy·ªát v·ªùi! B·∫°n ƒë√£ ƒë·∫°t ƒë·ªânh cao danh v·ªçng (5 Ti·ªÅn) v√† h·∫°nh ph√∫c vi√™n m√£n (5 Vui).<br>M·ªçi ng∆∞·ªùi ƒë·ªÅu s·ªëng s√≥t.</p>
        <button class="btn btn-win" onclick="initGame()">S·ªëng L·∫°i Cu·ªôc ƒê·ªùi M·ªõi</button>
    </div>

    <div id="toast">Th√¥ng b√°o...</div>

<script>
    // --- DATA CONFIGURATION ---
    const NPC_ICONS = {
        'mom': 'üëµ',
        'gf': 'üíÉ',
        'boss': 'ü§µ',
        'friend': 'üç∫',
        'colleague': 'üíº'
    };

    const DECK_TEMPLATE = [
        { name: "T·ª´ Thi·ªán", pM: -2, pH: 0, nM: 1, nH: 1, desc: "Gi√∫p ng∆∞·ªùi" },
        { name: "Tr·∫•n L·ªôt", pM: 2, pH: 0, nM: -1, nH: -1, desc: "C∆∞·ªõp b√≥c" },
        { name: "T·∫•u H√†i", pM: 0, pH: -2, nM: 0, nH: 2, desc: "L√†m tr√≤" },
        { name: "C√† Kh·ªãa", pM: 0, pH: 2, nM: 0, nH: -2, desc: "Ch√¢m ch·ªçc" },
        { name: "Mua Qu√†", pM: -1, pH: 1, nM: 0, nH: 1, desc: "T·∫∑ng qu√†" }, 
        { name: "B√°n M√°u", pM: 2, pH: -2, nM: 0, nH: 0, desc: "C√†y cu·ªëc" }, // New Hardcore
        { name: "Ti·ªác T√πng", pM: -1, pH: 1, nM: -1, nH: 1, desc: "X·∫£ l√°ng" },
        { name: "Tranh C√£i", pM: 0, pH: -1, nM: 0, nH: -1, desc: "G√¢y g·ªï" },
        { name: "Vay M∆∞·ª£n", pM: 2, pH: -1, nM: -2, nH: 0, desc: "M∆∞·ª£n ti·ªÅn" }, // New
        { name: "An ·ª¶i", pM: 0, pH: 1, nM: 0, nH: 1, desc: "Chia s·∫ª" }
    ];

    const NPCS_DATA = [
        { id: 'mom', name: "M·∫π", money: 3, happy: 3 },
        { id: 'gf', name: "B·∫°n G√°i", money: 3, happy: 3 },
        { id: 'friend', name: "B·∫°n Th√¢n", money: 3, happy: 3 },
        { id: 'boss', name: "S·∫øp", money: 3, happy: 3 },
        { id: 'colleague', name: "ƒê·ªìng Nghi·ªáp", money: 3, happy: 3 }
    ];

    // --- STATE VARIABLES ---
    let player = { money: 3, happy: 3 };
    let npcs = [];
    let currentHand = []; // Stores the 3 active cards
    let currentNPC = null;
    let currentRequest = null;
    let turnCount = 1;

    // --- INITIALIZATION ---
    function initGame() {
        document.getElementById('gameOverOverlay').style.display = 'none';
        document.getElementById('winOverlay').style.display = 'none';
        
        player = { money: 3, happy: 3 };
        npcs = JSON.parse(JSON.stringify(NPCS_DATA));
        turnCount = 1;

        // Init Hand with 3 random cards
        currentHand = [getRandomCard(), getRandomCard(), getRandomCard()];

        nextTurn();
    }

    // --- CORE LOOP ---
    function nextTurn() {
        // 1. Pick NPC
        currentNPC = npcs[Math.floor(Math.random() * npcs.length)];
        
        // 2. Generate Request
        generateRequest(currentNPC);

        // 3. Render
        renderUI();
    }

    function generateRequest(npc) {
        const types = ['money', 'happy'];
        const type = types[Math.floor(Math.random() * types.length)];
        let val = Math.random() > 0.4 ? 1 : -1; // 60% chance asking for +

        // Custom Logic for Personality
        if (npc.id === 'mom' && Math.random() > 0.5) val = -1; // Mom likes to give
        if (npc.id === 'boss') val = 1; // Boss usually takes

        currentRequest = { type, val };
        
        // Generate Dialog based on NPC status
        let dialog = "...";
        const needsMoney = npc.money < 3;
        const needsHappy = npc.happy < 3;

        if (type === 'money' && val === 1) dialog = needsMoney ? "Tao ƒë√≥i qu√°, cho xin √≠t ti·ªÅn..." : "ƒêang c·∫ßn v·ªën l√†m ƒÉn l·ªõn.";
        if (type === 'money' && val === -1) dialog = "C·∫ßm l·∫•y √≠t ti·ªÅn ti√™u v·∫∑t ƒëi.";
        if (type === 'happy' && val === 1) dialog = needsHappy ? "D·∫°o n√†y tr·∫ßm c·∫£m qu√°..." : "L√†m g√¨ cho vui ƒëi!";
        if (type === 'happy' && val === -1) dialog = "Tao nh∆∞·ªùng m√†y vui ƒë√≥.";

        document.getElementById('npcDialog').innerText = `"${dialog}"`;
        document.getElementById('npcIcon').innerText = NPC_ICONS[npc.id];
    }

    function renderUI() {
        // Player Stats
        document.getElementById('pMoneyVal').innerHTML = `üí∞ ${player.money}`;
        document.getElementById('pHappyVal').innerHTML = `üòÇ ${player.happy}`;
        
        // NPC Stats
        document.getElementById('nMoneyVal').innerHTML = `üí∞ ${currentNPC.money}`;
        document.getElementById('nHappyVal').innerHTML = `üòÇ ${currentNPC.happy}`;
        document.getElementById('npcName').innerText = currentNPC.name;

        // Context Badge
        let contextText = "B√¨nh th∆∞·ªùng";
        if (currentNPC.money <= 1) contextText = "ƒêang ngh√®o t√∫ng";
        else if (currentNPC.money >= 5) contextText = "ƒê·∫°i gia";
        else if (currentNPC.happy <= 1) contextText = "Tr·∫ßm c·∫£m";
        else if (currentNPC.happy >= 5) contextText = "H·∫°nh ph√∫c t·ªôt ƒë·ªânh";
        document.getElementById('npcContext').innerText = contextText;

        // Request Tag
        const reqEl = document.getElementById('npcRequest');
        if (currentRequest.type === 'money') {
            reqEl.innerText = currentRequest.val > 0 ? "C·∫¶N: + TI·ªÄN" : "C·∫¶N: - TI·ªÄN";
            reqEl.style.backgroundColor = currentRequest.val > 0 ? '#27ae60' : '#e67e22';
        } else {
            reqEl.innerText = currentRequest.val > 0 ? "C·∫¶N: + VUI" : "C·∫¶N: - VUI";
            reqEl.style.backgroundColor = currentRequest.val > 0 ? '#f1c40f' : '#8e44ad';
        }

        renderCards();
    }

    function renderCards() {
        const area = document.getElementById('cardsArea');
        area.innerHTML = '';

        currentHand.forEach((card, index) => {
            const el = document.createElement('div');
            
            // Check Penalty Logic for Styling
            const isPenalty = checkPenalty(card);
            
            el.className = `card ${isPenalty ? 'penalty' : ''}`;
            el.onclick = () => playCard(index);

            el.innerHTML = `
                <div class="card-header">${card.name}</div>
                <div class="card-body">
                    <div class="effect-line">
                        <span class="badge badge-player">B·∫°n</span>
                        <span>
                            ${formatStat(card.pM, 'üí∞')} 
                            ${formatStat(card.pH, 'üòÇ')}
                        </span>
                    </div>
                    <div class="effect-line">
                        <span class="badge badge-npc">NPC</span>
                        <span>
                            ${formatStat(card.nM, 'üí∞')} 
                            ${formatStat(card.nH, 'üòÇ')}
                        </span>
                    </div>
                    ${isPenalty ? '<div class="penalty-warning">‚ö†Ô∏è Ph·∫°t -1 Ti·ªÅn</div>' : ''}
                </div>
            `;
            area.appendChild(el);
        });
    }

    // --- GAME LOGIC HELPERS ---

    function getRandomCard() {
        return DECK_TEMPLATE[Math.floor(Math.random() * DECK_TEMPLATE.length)];
    }

    function formatStat(val, icon) {
        if (val === 0) return "";
        return `${val > 0 ? '+' : ''}${val}${icon}`;
    }

    function checkPenalty(card) {
        // Logic: Unhappy (0,1,2) but choose +Happy card -> Penalty
        // Logic: Happy (3,4,5) but choose -Happy card -> Penalty
        if (player.happy < 3 && card.pH > 0) return true;
        if (player.happy >= 3 && card.pH < 0) return true;
        return false;
    }

    function playCard(index) {
        const card = currentHand[index];
        
        // 1. Penalty Check
        let penaltyCost = 0;
        if (checkPenalty(card)) {
            penaltyCost = 1;
            showToast("Gi·∫£ b·ªô c·∫£m x√∫c! B·∫°n b·ªã ph·∫°t 1 Ti·ªÅn.");
        }

        // 2. Request Satisfaction Check
        let satisfied = false;
        if (currentRequest.type === 'money') {
            if (currentRequest.val > 0 && card.nM > 0) satisfied = true;
            if (currentRequest.val < 0 && card.nM < 0) satisfied = true;
        } else {
            if (currentRequest.val > 0 && card.nH > 0) satisfied = true;
            if (currentRequest.val < 0 && card.nH < 0) satisfied = true;
        }

        if (!satisfied) {
            currentNPC.happy -= 1;
            showToast(`${currentNPC.name} th·∫•t v·ªçng (-1 Vui)`);
        }

        // 3. Apply Stats
        player.money = player.money - penaltyCost + card.pM;
        player.happy += card.pH;
        currentNPC.money += card.nM;
        currentNPC.happy += card.nH;

        // 4. Clamp & Check Win/Loss
        clampStats(player);
        clampStats(currentNPC);

        if (checkEndGame()) return;

        // 5. Update Hand (Replace used card only)
        currentHand[index] = getRandomCard();
        
        turnCount++;
        nextTurn();
    }

    function clampStats(entity) {
        if (entity.money > 5) entity.money = 5;
        if (entity.money < 0) entity.money = 0;
        if (entity.happy > 5) entity.happy = 5;
        if (entity.happy < 0) entity.happy = 0;
    }

    function checkEndGame() {
        // VICTORY
        if (player.money === 5 && player.happy === 5) {
            document.getElementById('winOverlay').style.display = 'flex';
            return true;
        }

        // DEFEAT
        let reason = null;
        if (player.money <= 0) reason = "B·∫°n ƒë√£ ph√° s·∫£n.";
        else if (player.happy <= 0) reason = "B·∫°n ƒë√£ tuy·ªát v·ªçng.";
        
        npcs.forEach(npc => {
            if (npc.money <= 0) reason = `${npc.name} ƒë√£ ch·∫øt ƒë√≥i.`;
            if (npc.happy <= 0) reason = `${npc.name} ƒë√£ t·ª± t·ª≠ v√¨ bu·ªìn.`;
        });

        if (reason) {
            document.getElementById('failReason').innerText = reason;
            document.getElementById('gameOverOverlay').style.display = 'flex';
            return true;
        }
        return false;
    }

    function showToast(text) {
        const x = document.getElementById("toast");
        x.innerText = text;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    // Start
    initGame();

</script>
</body>
</html>